<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Juros Compostos — IndexV2.3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0d1224; --card:#111732; --muted:#9ab0c9; --text:#f1f5ff; --brand:#7fb2ff; --border:#243457;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; color:var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, #18214a 0, transparent 60%),
                  radial-gradient(1000px 600px at 110% 0%, #18214a 0, transparent 60%),
                  var(--bg);
    }
    .container{max-width:1080px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-weight:700;font-size:clamp(20px,2.6vw,32px)}
    .subtitle{color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:960px){.grid{grid-template-columns: 420px 1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent 40%) , var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.20);}
    .card .content{padding:18px}
    .field{display:flex;gap:8px;flex-direction:column;margin-bottom:12px}
    .label{font-weight:600;font-size:14px}
    .hint{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    input[type="text"], input[type="number"], select{
      width:100%; padding:11px 13px; border-radius:12px; border:1px solid var(--border); background:#0f1640; color:var(--text);
      outline:none; font-size:14px; transition:.2s border-color,.2s box-shadow;
    }
    input:focus, select:focus{border-color:var(--brand); box-shadow:0 0 0 3px rgba(127,178,255,.15)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    button{
      padding:11px 14px; border-radius:12px; border:1px solid var(--border); background:#101949; color:#fff; font-weight:600; cursor:pointer;
      transition:.2s transform,.2s background,.2s border-color;
    }
    button.primary{background:linear-gradient(180deg,#8ac0ff,#6aa9ff); border-color:#5b90e8; color:#0a122d}
    button.secondary:hover{border-color:var(--brand)}
    button:active{transform:translateY(1px)}
    .results{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.results{grid-template-columns:repeat(3,1fr)}}
    .stat{background:#0f1640;border:1px solid var(--border);border-radius:12px;padding:14px}
    .stat .k{font-size:12px;color:var(--muted)}
    .stat .v{font-weight:700;font-size:20px;margin-top:6px}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#0e1540;border:1px solid var(--border);color:#cfe0ff;font-size:12px}
    .footer-note{color:var(--muted);font-size:12px;margin-top:8px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid var(--border)}
    th{text-align:left;color:var(--muted);font-weight:600}
    tbody tr:hover{background:#101a4d}
    .scroll{max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px}
    .toggle{display:inline-flex;background:#0f1640;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .toggle button{background:transparent;border:0;padding:8px 10px}
    .toggle .active{background:#15204a;color:#cfe0ff}
    .pill{padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#cfe0ff}
    .separator{height:1px;background:var(--border);margin:10px 0}
    .disclaimer{font-size:12px;color:var(--muted);margin-top:10px}
    .chartWrap{height:360px; width:100%;}
    @media(max-width:720px){.chartWrap{height:240px}}
    canvas#grafico{display:block; width:100% !important; height:100% !important}
    details.advanced{margin-top:10px}
    details.advanced summary{cursor:pointer; list-style:none; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0f1640; color:#cfe0ff; font-weight:600}
    details.advanced[open] summary{border-bottom-left-radius:0;border-bottom-right-radius:0}
    .adv-body{border:1px solid var(--border); border-top:0; border-bottom-left-radius:10px; border-bottom-right-radius:10px; padding:12px; background:#0f1640}
    .mini-grid{display:grid; gap:10px; grid-template-columns:1fr 120px 120px}
    .list{margin-top:8px;border:1px dashed var(--border);border-radius:10px}
    .list table{font-size:12px}
    .list td,.list th{padding:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">Calculadora de Juros Compostos</div>
        <div class="subtitle">Aportes variáveis, inflação opcional, aportes extraordinários, gráfico e tabela mês a mês.</div>
      </div>
      <div class="tag">IndexV2.3 — HTML/CSS/JS</div>
    </header>

    <div class="grid">
      <section class="card" aria-label="Formulário de cálculo">
        <div class="content">
          <div class="field">
            <label class="label" for="valorInicial">Valor inicial</label>
            <input id="valorInicial" type="text" inputmode="decimal" placeholder="Ex.: 1.000,00" value="1.000,00" />
            <div class="hint">Quanto você começa investindo (R$).</div>
          </div>
          <div class="field">
            <label class="label" for="aporteMensal">Aporte mensal</label>
            <input id="aporteMensal" type="text" inputmode="decimal" placeholder="Ex.: 500,00" value="1.000,00" />
            <div class="hint">Quanto você pretende investir por mês (R$).</div>
          </div>
          <div class="row">
            <div class="field">
              <label class="label" for="taxa">Taxa de juros</label>
              <input id="taxa" type="number" step="0.01" placeholder="Ex.: 1" value="0.67" />
              <div class="hint">Informe a taxa no período selecionado (em %).</div>
            </div>
            <div class="field">
              <label class="label">Período da taxa</label>
              <div class="toggle" role="tablist" aria-label="Período da taxa">
                <button id="taxaMensal" class="active" aria-selected="true" role="tab">Mensal</button>
                <button id="taxaAnual" role="tab" aria-selected="false">Anual</button>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label class="label" for="periodo">Período</label>
              <input id="periodo" type="number" step="1" min="1" value="20" />
              <div class="hint">Quantidade de <span id="periodoLabel">anos</span>.</div>
            </div>
            <div class="field">
              <label class="label">Unidade do período</label>
              <div class="toggle" role="tablist" aria-label="Unidade do período">
                <button id="periodoMeses" role="tab" aria-selected="false">Meses</button>
                <button id="periodoAnos" class="active" role="tab" aria-selected="true">Anos</button>
              </div>
            </div>
          </div>
          <div class="actions">
            <button id="btnCalcular" class="primary">Calcular</button>
            <button id="btnLimpar" class="secondary" title="Limpar formulário">Limpar</button>
            <span class="pill" id="pilulaResumo"></span>
          </div>

          <details class="advanced">
            <summary>Opções avançadas</summary>
            <div class="adv-body">
              <div class="row">
                <div class="field">
                  <label class="label" for="inflacao">Inflação (a.a.)</label>
                  <input id="inflacao" type="number" step="0.01" placeholder="Ex.: 4" value="0" />
                  <div class="hint">Corrige automaticamente o <b>aporte mensal</b> ao longo dos meses.</div>
                </div>
                <div class="field">
                  <label class="label">Corrigir aporte pela inflação?</label>
                  <label class="hint"><input type="checkbox" id="corrigirAporte" /> Aplicar inflação todo mês</label>
                </div>
              </div>

              <div class="separator"></div>

              <div class="field">
                <div class="label">Mudanças programadas no aporte</div>
                <div class="mini-grid">
                  <input id="ajusteMes" type="number" min="1" placeholder="Mês a partir de… (ex.: 13)" />
                  <input id="ajusteValor" type="text" placeholder="Novo aporte (R$)" />
                  <button id="addAjuste" type="button">Adicionar</button>
                </div>
                <div class="hint">O novo valor passa a valer daquele mês em diante (com inflação a partir desse mês, se ligada).</div>
                <div class="list">
                  <table id="tAjustes">
                    <thead><tr><th>Mês início</th><th>Novo aporte</th><th>Ação</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="separator"></div>

              <div class="field">
                <div class="label">Aportes extraordinários</div>
                <div class="mini-grid">
                  <input id="extraMes" type="number" min="1" placeholder="Mês (ex.: 6)" />
                  <input id="extraValor" type="text" placeholder="Valor (R$)" />
                  <button id="addExtra" type="button">Adicionar</button>
                </div>
                <div class="hint">Depósitos únicos em meses específicos (bônus, 13º, venda de bem, etc.).</div>
                <div class="list">
                  <table id="tExtras">
                    <thead><tr><th>Mês</th><th>Valor</th><th>Ação</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="disclaimer">Obs.: a inflação é aplicada <b>apenas</b> aos aportes mensais, não ao saldo já investido.</div>
            </div>
          </details>
        </div>
      </section>

      <section class="card" aria-label="Resultados">
        <div class="content">
          <div class="results">
            <div class="stat"><div class="k">Total investido</div><div id="totalInvestido" class="v">—</div></div>
            <div class="stat"><div class="k">Juros acumulados</div><div id="jurosAcumulados" class="v">—</div></div>
            <div class="stat"><div class="k">Montante final</div><div id="montanteFinal" class="v">—</div></div>
          </div>
          <div class="separator"></div>
          <div class="chartWrap"><canvas id="grafico" aria-label="Gráfico de evolução" role="img"></canvas></div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px" aria-label="Tabela detalhada">
      <div class="content">
        <div class="row" style="align-items:center;justify-content:space-between;gap:8px">
          <h2 style="margin:0;font-size:18px">Tabela (mês a mês)</h2>
          <button id="btnExport" type="button">Exportar CSV</button>
        </div>
        <div class="scroll" style="margin-top:10px">
          <table id="tabela">
            <thead>
              <tr>
                <th>Mês</th>
                <th>Saldo Inicial</th>
                <th>Juros do Mês</th>
                <th>Aporte</th>
                <th>Saldo Final</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="footer-note">Regra usada: juros compostos mensais. Sequência do mês: <em>juros sobre o saldo</em> + <em>aporte do mês</em>.</div>
      </div>
    </section>

    <p class="disclaimer">Projeto educacional. Personalize cores e textos conforme sua marca.</p>
  </div>

<script>
const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
const parseBRL = (s) => { if (typeof s==='number') return s; if(!s) return 0;
  s=String(s).trim().replace(/[^0-9,.-]/g,'').replace(/\.(?=\d{3}(\D|$))/g,'').replace(',', '.'); const v=parseFloat(s); return isNaN(v)?0:v };
const el = (id)=> document.getElementById(id);

// Toggles
const taxaMensalBtn = el('taxaMensal');
const taxaAnualBtn  = el('taxaAnual');
const periodoMesesBtn = el('periodoMeses');
const periodoAnosBtn  = el('periodoAnos');
const periodoLabel = el('periodoLabel');
function setActive(btn, peer){ btn.classList.add('active'); btn.setAttribute('aria-selected','true');
  peer.classList.remove('active'); peer.setAttribute('aria-selected','false'); }
if(taxaMensalBtn&&taxaAnualBtn){
  taxaMensalBtn.addEventListener('click', ()=> setActive(taxaMensalBtn,taxaAnualBtn));
  taxaAnualBtn.addEventListener('click', ()=> setActive(taxaAnualBtn,taxaMensalBtn));
}
if(periodoMesesBtn&&periodoAnosBtn){
  periodoMesesBtn.addEventListener('click', ()=>{ setActive(periodoMesesBtn, periodoAnosBtn); periodoLabel.textContent='meses'; });
  periodoAnosBtn.addEventListener('click', ()=>{ setActive(periodoAnosBtn, periodoMesesBtn); periodoLabel.textContent='anos'; });
}

// Estado avançado
const ajustes=[]; // {mesInicio, novoAporte}
const extras=[];  // {mes, valor}
function renderAjustes(){ const tbody=document.querySelector('#tAjustes tbody'); if(!tbody) return;
  tbody.innerHTML=ajustes.sort((a,b)=>a.mesInicio-b.mesInicio)
    .map((a,i)=>`<tr><td>${a.mesInicio}</td><td>${fmt.format(a.novoAporte)}</td><td><button data-del-ajust=\"${i}\">Remover</button></td></tr>`).join(''); }
function renderExtras(){ const tbody=document.querySelector('#tExtras tbody'); if(!tbody) return;
  tbody.innerHTML=extras.sort((a,b)=>a.mes-b.mes)
    .map((e,i)=>`<tr><td>${e.mes}</td><td>${fmt.format(e.valor)}</td><td><button data-del-extra=\"${i}\">Remover</button></td></tr>`).join(''); }
const addAjusteBtn=el('addAjuste');
if(addAjusteBtn){
  addAjusteBtn.addEventListener('click',()=>{
    const m=parseInt(el('ajusteMes').value,10);
    const v=parseBRL(el('ajusteValor').value);
    if(!m||m<1||!v){ alert('Informe mês (>=1) e valor válido.'); return; }
    ajustes.push({mesInicio:m, novoAporte:v});
    el('ajusteMes').value=''; el('ajusteValor').value=''; renderAjustes();
  });
  document.addEventListener('click',(ev)=>{
    const b=ev.target.closest('button[data-del-ajust]');
    if(b){ ajustes.splice(parseInt(b.getAttribute('data-del-ajust'),10),1); renderAjustes(); }
  });
}
const addExtraBtn=el('addExtra');
if(addExtraBtn){
  addExtraBtn.addEventListener('click',()=>{
    const m=parseInt(el('extraMes').value,10);
    const v=parseBRL(el('extraValor').value);
    if(!m||m<1||!v){ alert('Informe mês (>=1) e valor válido.'); return; }
    extras.push({mes:m, valor:v});
    el('extraMes').value=''; el('extraValor').value=''; renderExtras();
  });
  document.addEventListener('click',(ev)=>{
    const b=ev.target.closest('button[data-del-extra]');
    if(b){ extras.splice(parseInt(b.getAttribute('data-del-extra'),10),1); renderExtras(); }
  });
}

// === Cálculo principal ===
function calcular(){
  const C0 = parseBRL(el('valorInicial').value);
  const aporteBase = parseBRL(el('aporteMensal').value);
  const taxa = parseFloat(el('taxa').value)||0;
  const isTaxaAnual = taxaAnualBtn && taxaAnualBtn.classList.contains('active');
  let periodo = parseInt(el('periodo').value,10)||0;
  const isPeriodoAnos = periodoAnosBtn && periodoAnosBtn.classList.contains('active');

  // Avançado
  const inflacaoAA = parseFloat(el('inflacao')?.value||'0');
  const corrigirAporte = el('corrigirAporte')?.checked||false;

  if(periodo<1||taxa<0){ alert('Verifique os campos.'); return null; }
  const meses = isPeriodoAnos? periodo*12: periodo;
  const i_m   = isTaxaAnual? (Math.pow(1+taxa/100,1/12)-1): (taxa/100);
  const infl_m= inflacaoAA>0? (Math.pow(1+inflacaoAA/100,1/12)-1): 0;

  function aporteNoMes(m){
    let baseValor = aporteBase;
    let baseMes = 1;
    if (ajustes.length){
      let vigente = null;
      for (const a of ajustes){
        if (a.mesInicio <= m && (vigente === null || a.mesInicio > vigente.mesInicio)) vigente = a;
      }
      if (vigente){ baseValor = vigente.novoAporte; baseMes = vigente.mesInicio; }
    }
    if (corrigirAporte && infl_m > 0){
      const expo = Math.max(0, m - baseMes);
      return baseValor * Math.pow(1 + infl_m, expo);
    }
    return baseValor;
  }

  let saldo=C0; const linhas=[]; let totalInvestido=C0;
  const pontosMontante=[saldo]; const pontosInvestido=[totalInvestido];

  for(let m=1;m<=meses;m++){
    const juros=saldo*i_m; saldo+=juros;
    const aporte=aporteNoMes(m); saldo+=aporte; totalInvestido+=aporte;
    const extraV=extras.filter(e=>e.mes===m).reduce((s,e)=>s+e.valor,0);
    if(extraV>0){ saldo+=extraV; totalInvestido+=extraV; }
    linhas.push({ mes:m, inicial: saldo-juros-aporte-extraV, juros, aporte: aporte+extraV, final: saldo });
    pontosMontante.push(saldo); pontosInvestido.push(totalInvestido);
  }
  const jurosAcumulados = saldo - totalInvestido;
  return { meses, i_m, totalInvestido, jurosAcumulados, montante: saldo, linhas, pontosMontante, pontosInvestido };
}

// UI e Gráfico
const totalInvestidoEl=el('totalInvestido');
const jurosAcumuladosEl=el('jurosAcumulados');
const montanteFinalEl=el('montanteFinal');
const tabelaBody=document.querySelector('#tabela tbody');
const resumo=el('pilulaResumo');

function renderTabela(linhas){
  tabelaBody.innerHTML = linhas.map(l=>`
    <tr>
      <td>${l.mes}</td>
      <td>${fmt.format(l.inicial)}</td>
      <td>${fmt.format(l.juros)}</td>
      <td>${fmt.format(l.aporte)}</td>
      <td>${fmt.format(l.final)}</td>
    </tr>`).join('');
}
function renderStats(r){
  totalInvestidoEl.textContent = fmt.format(r.totalInvestido);
  jurosAcumuladosEl.textContent = fmt.format(r.jurosAcumulados);
  montanteFinalEl.textContent = fmt.format(r.montante);
  resumo.textContent = `${r.meses} meses • taxa mensal eq.: ${(r.i_m*100).toFixed(3)}%`;
}

let chart;
function renderGrafico(r){
  const ctx = document.getElementById('grafico').getContext('2d');
  if (chart) chart.destroy();
  const usePoints = r.meses <= 180; // evita poluição em prazos muito longos
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: Array.from({length: r.meses+1}, (_,i)=> i),
      datasets: [
        { label: 'Montante', data: r.pontosMontante, borderWidth: 2, tension:.25,
          borderColor:'#6aa9ff', backgroundColor:'rgba(106,169,255,0.2)',
          pointRadius: usePoints ? 3 : 0, pointHoverRadius: usePoints ? 6 : 0, fill:true },
        { label: 'Total investido', data: r.pontosInvestido, borderWidth: 2, tension:.25,
          borderColor:'#f16b6b', backgroundColor:'rgba(241,107,107,0.25)',
          pointRadius: usePoints ? 3 : 0, pointHoverRadius: usePoints ? 6 : 0, fill:true },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:'index', intersect:false },
      plugins: {
        legend: { labels: { color: '#cfe0ff' } },
        tooltip: { 
          callbacks: {
            title: (items)=> 'Mês ' + items[0].label,
            label: (ctx)=> `${ctx.dataset.label}: ${fmt.format(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        x: { ticks:{ color:'#9fb2d0' }, grid:{ color:'#1a2448', borderDash:[4,4] } },
        y: { beginAtZero:true, ticks:{ color:'#9fb2d0', callback:(v)=> fmt.format(v) }, grid:{ color:'#1a2448', borderDash:[4,4] } },
      }
    }
  });
}

function exportCSV(linhas){
  const header = ['Mes','SaldoInicial','JurosMes','Aporte','SaldoFinal'];
  const rows = linhas.map(l=> [l.mes, l.inicial, l.juros, l.aporte, l.final]);
  const csv = [header.join(';')].concat(rows.map(r=> r.join(';'))).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'tabela-juros-compostos.csv'; a.click();
  URL.revokeObjectURL(url);
}

el('btnCalcular').addEventListener('click', ()=>{
  const r = calcular(); if (!r) return;
  renderStats(r); renderTabela(r.linhas); renderGrafico(r);
});
el('btnLimpar').addEventListener('click', ()=>{
  el('valorInicial').value = '';
  el('aporteMensal').value = '';
  el('taxa').value = '';
  el('periodo').value = '12';
  ajustes.length = 0; extras.length = 0;
  const tA=document.querySelector('#tAjustes tbody'); if(tA) tA.innerHTML='';
  const tE=document.querySelector('#tExtras tbody'); if(tE) tE.innerHTML='';
  document.getElementById('inflacao').value = '0';
  document.getElementById('corrigirAporte').checked = false;
  tabelaBody.innerHTML = '';
  totalInvestidoEl.textContent = '—';
  jurosAcumuladosEl.textContent = '—';
  montanteFinalEl.textContent = '—';
  resumo.textContent = '';
  if (chart) { chart.destroy(); chart = null; }
});
el('btnExport').addEventListener('click', ()=>{
  const r = calcular(); if (!r) return; exportCSV(r.linhas);
});

function maskBRLOnBlur(id){
  const i=el(id); if(!i) return;
  i.addEventListener('blur', ()=>{ const v=parseBRL(i.value); i.value = v? fmt.format(v): '' });
}
['valorInicial','aporteMensal','ajusteValor','extraValor'].forEach(maskBRLOnBlur);

document.addEventListener('DOMContentLoaded', ()=>{
  const r = calcular(); if (r){ renderStats(r); renderTabela(r.linhas); renderGrafico(r); }
  renderAjustes(); renderExtras();
});
</script>
</body>
</html>

